---
# ZFS core - OpenZFS repository, packages, kernel lock, and services for Fedora

- name: Install ZFS
  when: zfs_state == 'present'
  become: true
  block:
    - name: Remove zfs-fuse if present (conflicts with OpenZFS)
      ansible.builtin.dnf:
        name: zfs-fuse
        state: absent

    - name: Check if ZFS repo is installed
      ansible.builtin.stat:
        path: /etc/yum.repos.d/zfs.repo
      register: zfs_repo_check

    - name: Install ZFS repository
      ansible.builtin.dnf:
        name: "{{ zfs_repo_url }}"
        state: present
        disable_gpg_check: true
      when: not zfs_repo_check.stat.exists

    - name: Install kernel headers (required for DKMS)
      ansible.builtin.dnf:
        name:
          - kernel-devel
          - kernel-headers
        state: present

    - name: Install ZFS packages
      ansible.builtin.dnf:
        name: "{{ zfs_packages }}"
        state: present

    - name: Load ZFS kernel module
      community.general.modprobe:
        name: zfs
        state: present

    # Kernel version lock to prevent ZFS breakage from major version updates
    # Locks to minor version (e.g., 6.18.x) to allow patch updates while blocking major changes
    # Uses DNF5 versionlock TOML format with evr range conditions
    - name: Extract kernel version info
      ansible.builtin.set_fact:
        zfs_kernel_minor_version: "{{ ansible_facts['kernel'] | regex_search('^[0-9]+\\.[0-9]+') }}"
      when: zfs_kernel_lock | bool

    - name: Calculate next kernel minor version
      vars:
        zfs_kernel_major: "{{ zfs_kernel_minor_version.split('.')[0] }}"
        zfs_kernel_minor_int: "{{ zfs_kernel_minor_version.split('.')[1] | int + 1 }}"
      ansible.builtin.set_fact:
        zfs_kernel_next_minor_version: "{{ zfs_kernel_major ~ '.' ~ zfs_kernel_minor_int }}"
      when: zfs_kernel_lock | bool

    - name: Deploy kernel versionlock config
      ansible.builtin.template:
        src: versionlock.toml.j2
        dest: /etc/dnf/versionlock.toml
        mode: "0644"
      when: zfs_kernel_lock | bool

    - name: Deploy zfs-load-key service for encrypted pools
      ansible.builtin.copy:
        src: zfs-load-key.service
        dest: /etc/systemd/system/zfs-load-key.service
        mode: "0644"
      notify: Reload systemd

    - name: Flush handlers to reload systemd
      ansible.builtin.meta: flush_handlers

    - name: Enable ZFS services
      ansible.builtin.systemd_service:
        name: "{{ item }}"
        enabled: true
      loop:
        - zfs-import-cache.service
        - zfs-load-key.service
        - zfs-mount.service
        - zfs-import.target
        - zfs.target
        - zfs-zed.service

    # Create datasets if they don't exist
    # Mount directly to ~/data
    - name: Create parent data dataset
      community.general.zfs:
        name: "{{ zfs_zrepl.poolname }}/data"
        state: present
        extra_zfs_properties:
          mountpoint: "/home/{{ primary_user }}/data"
          canmount: "on"

    - name: Set ownership on parent data dataset
      ansible.builtin.file:
        path: "/home/{{ primary_user }}/data"
        owner: "{{ primary_user }}"
        group: "{{ primary_user }}"
        mode: "0755"
        state: directory

    - name: Create data child datasets
      community.general.zfs:
        name: "{{ zfs_zrepl.poolname }}/data/{{ item.name }}"
        state: present
        extra_zfs_properties:
          canmount: "on"
      loop: "{{ zfs_data_datasets }}"

    - name: Set ownership on data child datasets
      ansible.builtin.file:
        path: "/home/{{ primary_user }}/data/{{ item.name }}"
        owner: "{{ primary_user }}"
        group: "{{ primary_user }}"
        mode: "{{ item.mode }}"
        state: directory
      loop: "{{ zfs_data_datasets }}"

- name: Remove ZFS
  when: zfs_state == 'absent'
  become: true
  block:
    - name: Disable ZFS services
      ansible.builtin.systemd_service:
        name: "{{ item }}"
        enabled: false
        state: stopped
      loop:
        - zfs-zed.service
        - zfs-load-key.service
        - zfs-import-cache.service
        - zfs-mount.service
        - zfs-import.target
        - zfs.target
      failed_when: false

    - name: Remove zfs-load-key service
      ansible.builtin.file:
        path: /etc/systemd/system/zfs-load-key.service
        state: absent

    - name: Reset kernel versionlock
      ansible.builtin.copy:
        content: |
          version = "1.0"
          packages = []
        dest: /etc/dnf/versionlock.toml
        mode: "0644"

    - name: Remove ZFS packages
      ansible.builtin.dnf:
        name: "{{ zfs_packages }}"
        state: absent
      failed_when: false
