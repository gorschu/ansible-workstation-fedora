---
# Niri wayland compositor and ecosystem

- name: Niri installation and configuration
  when: niri_state == 'present'
  block:
    # Core components always installed
    - name: Install Niri core components
      become: true
      ansible.builtin.dnf:
        name: "{{ niri_core_packages }}"
        state: present

    # Traditional component-based desktop shell (without DMS)
    - name: Traditional desktop shell setup
      when: dms_state | default('absent') != 'present'
      block:
        - name: Enable Hyprland COPR repository
          become: true
          community.general.copr:
            name: sdegler/hyprland
            state: enabled

        - name: Install traditional Niri ecosystem
          become: true
          ansible.builtin.dnf:
            name: "{{ niri_traditional_packages }}"
            state: present

    # Cleanup traditional components when switching to DMS
    - name: Cleanup traditional components (switching to DMS)
      when: dms_state | default('absent') == 'present'
      block:
        - name: Remove traditional ecosystem packages
          become: true
          ansible.builtin.dnf:
            name: "{{ niri_traditional_packages }}"
            state: absent

        - name: Disable Hyprland COPR repository
          become: true
          community.general.copr:
            name: sdegler/hyprland
            state: disabled
          when: hyprland_state | default('absent') != 'present'

# Removal/cleanup when niri_state == 'absent'
- name: Niri removal
  when: niri_state == 'absent'
  block:
    - name: Remove Niri core components
      become: true
      ansible.builtin.dnf:
        name: "{{ niri_core_packages }}"
        state: absent

    - name: Remove traditional ecosystem components
      become: true
      ansible.builtin.dnf:
        name: "{{ niri_traditional_packages }}"
        state: absent

    - name: Disable Hyprland COPR repository
      become: true
      community.general.copr:
        name: sdegler/hyprland
        state: disabled
      when: hyprland_state | default('absent') != 'present'
